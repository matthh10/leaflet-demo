[
  {
    "objectID": "tutorial.html",
    "href": "tutorial.html",
    "title": "How to make maps with {leaflet} in R",
    "section": "",
    "text": "Maps are often useful in public health to understand the spatial distribution of cases and identify clusters. The {leaflet} package in R is useful for quickly creating interactive maps using free, open-source data (Cheng et al. 2025).\nUsing publicly available data on GP practices in Scotland and geographical data from the Scottish postcode directory, this tutorial will demonstrate how to produce basic maps using {leaflet} and outline some key features of the package."
  },
  {
    "objectID": "tutorial.html#overview",
    "href": "tutorial.html#overview",
    "title": "How to make maps with {leaflet} in R",
    "section": "",
    "text": "Maps are often useful in public health to understand the spatial distribution of cases and identify clusters. The {leaflet} package in R is useful for quickly creating interactive maps using free, open-source data (Cheng et al. 2025).\nUsing publicly available data on GP practices in Scotland and geographical data from the Scottish postcode directory, this tutorial will demonstrate how to produce basic maps using {leaflet} and outline some key features of the package."
  },
  {
    "objectID": "tutorial.html#load-packages",
    "href": "tutorial.html#load-packages",
    "title": "How to make maps with {leaflet} in R",
    "section": "Load Packages",
    "text": "Load Packages\n\nif(!require(\"pacman\")) {\n  install.packages(\"pacman\")\n}\n\npacman::p_load(tidyverse, # For data wrangling and vis \n               leaflet, # For making interactive \n               phsopendata, # For gp data\n               phslookups, # For converting postcodes to coordinates\n               phmethods, # For formatting poscodes\n               janitor, # For cleaning data\n               purrr, # For working with lists\n               htmltools, glue) # For making nice labels"
  },
  {
    "objectID": "tutorial.html#load-in-data",
    "href": "tutorial.html#load-in-data",
    "title": "How to make maps with {leaflet} in R",
    "section": "Load in Data",
    "text": "Load in Data\nWe will be using data from {phsopendata} on GP locations and size in Scotland (Scharle et al. 2025).\n\ngp_data &lt;- phsopendata::get_dataset(\"gp-practice-contact-details-and-list-sizes\") |&gt; \n  janitor::clean_names()  # Tidys column names\n\nglimpse(gp_data)\n\nRows: 39,808\nColumns: 19\n$ practice_code      &lt;dbl&gt; 10002, 10017, 10036, 10106, 10125, 10182, 10233, 10…\n$ gp_practice_name   &lt;chr&gt; \"Muirhead Medical Centre\", \"The Blue Practice\", \"Ab…\n$ practice_list_size &lt;chr&gt; \"8491\", \"7706\", \"4861\", \"6442\", \"4669\", \"9728\", \"70…\n$ address_line1      &lt;chr&gt; \"Muirhead Medical Centre\", \"The Blue Practice\", \"Ab…\n$ address_line2      &lt;chr&gt; \"Liff Road\", \"Crieff Medical Centre\", \"Taybridge Ro…\n$ address_line3      &lt;chr&gt; \"Muirhead\", \"King Street\", \"Aberfeldy\", \"Broughty F…\n$ address_line4      &lt;chr&gt; NA, \"Crieff\", \"Perthshire\", \"Dundee\", NA, NA, NA, N…\n$ postcode           &lt;chr&gt; \"DD2 5NH\", \"PH7 3SA\", \"PH15 2BL\", \"DD5 1DU\", \"PH11 …\n$ telephone_number   &lt;chr&gt; \"01382 580 264\", \"01764 652 283\", \"01887 820 366\", …\n$ practice_type      &lt;chr&gt; \"GMS\", \"GMS\", \"GMS\", \"GMS\", \"GMS\", \"GMS\", \"2C\", \"GM…\n$ dispensing         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…\n$ hb                 &lt;chr&gt; \"S08000030\", \"S08000030\", \"S08000030\", \"S08000030\",…\n$ hscp               &lt;chr&gt; \"S37000007\", \"S37000033\", \"S37000033\", \"S37000007\",…\n$ data_zone          &lt;chr&gt; \"S01007129\", \"S01011870\", \"S01012014\", \"S01007758\",…\n$ gp_cluster         &lt;chr&gt; \"Dundee 4\", \"Strathearn Cluster\", \"North West Perth…\n$ practice_name      &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…\n$ listsize           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…\n$ telephone          &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…\n$ ca                 &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…\n\n\nSome practices are duplicated so we will only keep one entry per practice code, keeping the entry with the largest list size.\n\ngp_data_filtered &lt;- gp_data |&gt; \n  mutate(practice_code = as.factor(practice_code),\n         practice_list_size = as.numeric(practice_list_size)) |&gt; \n  group_by(practice_code) |&gt; \n  slice_max(practice_list_size, n = 1) |&gt; \n  ungroup()\n\nWarning: There was 1 warning in `mutate()`.\nℹ In argument: `practice_list_size = as.numeric(practice_list_size)`.\nCaused by warning:\n! NAs introduced by coercion"
  },
  {
    "objectID": "tutorial.html#extract-geographic-data",
    "href": "tutorial.html#extract-geographic-data",
    "title": "How to make maps with {leaflet} in R",
    "section": "Extract geographic data",
    "text": "Extract geographic data\nThe data set from {phsopendata} includes the postcode (gp_data$postcode) for each practice in Scotland. To plot each practice on a map, we must first convert these postcodes into map coordinates (latitude and longitude). We can do this using the Scottish postcode directory, which can be loaded into the R environment using {phslookups}.\n\nremotes::install_github(\"Public-Health-Scotland/phslookups\")\n\n\nspd &lt;- phslookups::get_spd()\n\nℹ Using the latest available version:\n\"Scottish_Postcode_Directory_2025_2\".\nIf you require an older version or for reproducibility purposes\nplease specify the version argument accordingly.\n\nhead(spd)\n\n# A tibble: 6 × 95\n  pc7     pc8     split_char pc_district pc_sector date_of_introduction\n  &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;     &lt;date&gt;              \n1 AB1 0AA AB1 0AA &lt;NA&gt;       AB1         AB1 0     1980-01-01          \n2 AB1 0AB AB1 0AB &lt;NA&gt;       AB1         AB1 0     1973-08-01          \n3 AB1 0AD AB1 0AD &lt;NA&gt;       AB1         AB1 0     1973-08-01          \n4 AB1 0AE AB1 0AE &lt;NA&gt;       AB1         AB1 0     1994-02-01          \n5 AB1 0AF AB1 0AF &lt;NA&gt;       AB1         AB1 0     1990-12-01          \n6 AB1 0AG AB1 0AG &lt;NA&gt;       AB1         AB1 0     1990-12-01          \n# ℹ 89 more variables: date_of_deletion &lt;date&gt;, postcode_type &lt;chr&gt;,\n#   pc_su_link &lt;chr&gt;, split_su_link &lt;chr&gt;, imputed &lt;chr&gt;, dpc &lt;int&gt;,\n#   dpc_nr &lt;int&gt;, hhc &lt;int&gt;, grid_reference_easting &lt;int&gt;,\n#   grid_reference_northing &lt;int&gt;, latitude &lt;dbl&gt;, longitude &lt;dbl&gt;,\n#   split_indicator &lt;chr&gt;, ca2019 &lt;chr&gt;, ca2019name &lt;chr&gt;, ca2018 &lt;chr&gt;,\n#   ca2011 &lt;chr&gt;, upc2024 &lt;chr&gt;, spr2021 &lt;chr&gt;, spc2021 &lt;chr&gt;, ew2022 &lt;chr&gt;,\n#   hb2019 &lt;chr&gt;, hb2019name &lt;chr&gt;, hb2018 &lt;chr&gt;, hb2014 &lt;chr&gt;, hb2006 &lt;chr&gt;, …\n\n\nThis loads in a tibble with columns on geographic metadata for each postcode in Scotland. Postcodes are shown in both the PC8 and PC7 format, for this analysis we use the PC8 format. To join this geographic data to our filtered GP data, we must first ensure that the postcode column in our dataset is in the correct format using phsmethods::format_postcode(). We can then use dplyr::left_join() to join the two data frames by the correctly formatted postcodes. We are only interested in the latitude and longitude columns from spd, so we can select the columns we will need and ignore the rest.\n\ngeo_data &lt;- gp_data_filtered |&gt; \n  select(practice_code, practice_list_size, gp_practice_name, postcode, gp_cluster) |&gt; \n  mutate(pc8 = phsmethods::format_postcode(postcode, format = \"pc8\")) |&gt; # Ensure all postcodes are in PC8 format\n  left_join(\n    spd |&gt; \n      select(pc8, latitude, longitude, hb2019name), # Select required columns\n    join_by(pc8) # Join using the pc8 column\n  )"
  },
  {
    "objectID": "tutorial.html#create-map",
    "href": "tutorial.html#create-map",
    "title": "How to make maps with {leaflet} in R",
    "section": "Create map",
    "text": "Create map\nNow that we have a data frame with the coordinates and list size of each GP practice in Scotland, we can begin building a map.\nWe will first create a map widget by calling the leaflet() function and piping that into addTiles, which by default load OpenStreetMap data into our map widget as a new layer. We can then set the map view to show Scotland and define an appropriate default zoom using setView().\n\nm &lt;- leaflet() |&gt; # Create map widget\n  addTiles() |&gt; # Add map tile layer (defaults to OSM)\n  setView(-4.57, 57.88, zoom = 6) # Geographical centre of Scotland\n\nm\n\n\n\n\n\nOpenStreetMap provides open map data which is licensed under the Open Data Commons Open Database License (ODbL), which means you are free to copy, distribute, transmit and adapt their data, as long as you credit OpenStreetMap and its contributors. For more information, see: OpenStreetMap - Copyright and Licence.\n\nAdd markers and popups\nWe can add markers and popups to our map widget using addMarkers and addPopups:\n\nm |&gt;  \n  addMarkers(lng = -4.2654064, 55.8614359)\n\n\n\n\n\nPopups include the option to add text:\n\nm |&gt;  \n  addPopups(lng = -4.2654064, lat = 55.8614359, popup = 'This is 177 Bothwell Street')\n\n\n\n\n\n\n\nAdd GP practices\nWe can use the geographical data we produced earlier to add a marker for each GP practice in Scotland:\n\nm |&gt;\n  addMarkers(data = geo_data, # Data frame we produed earlier\n             lng = ~ longitude, # Column with longitude coordinates\n             lat = ~ latitude) # Column with latitude coordinates\n\n\n\n\n\nMarkers look a bit cluttered, so we can use circle markers instead:\n\nm |&gt;\n  addCircleMarkers(data = geo_data,\n                   lng = ~ longitude,\n                   lat = ~ latitude,\n                   radius = 0.5, # Set size of markers\n                   opacity = 0.3) # Set opacity of markers\n\n\n\n\n\nStill looks quite cluttered so we can set the clusterOptions argument to cluster markers by proximity:\n\nm |&gt;\n  addMarkers(\n    data = geo_data,\n    lng = ~ longitude,\n    lat = ~ latitude,\n    clusterOptions = markerClusterOptions()\n  )\n\n\n\n\n\n\n\nAdd labels\nLabels can also be added to markers using the popup argument inside addMarkers() :\n\nm |&gt;\n  addMarkers(\n    data = geo_data,\n    lng = ~ longitude,\n    lat = ~ latitude,\n    clusterOptions = markerClusterOptions(),\n    popup = ~ gp_practice_name)\n\n\n\n\n\nWe can write a function to create labels with html formatting using {htmltools}:\n\nmake_nice_label &lt;- function(gp_practice_name, practice_list_size, hb2019name) {\n  name_label &lt;- htmltools::span(\n    glue::glue('Practice name: {gp_practice_name}'),\n    style = htmltools::css(\n      font_weight = 600,\n      font_size = '16px'\n    )\n  )\n  size_label &lt;- htmltools::span(\n    glue::glue('List size: {practice_list_size}'),\n    style = htmltools::css(\n      font_size = '14px'\n    )\n  )\n  hb_label &lt;- htmltools::span(\n    glue::glue('Health board: {hb2019name}'),\n    style = htmltools::css(\n      font_size = '14px'\n    )\n  )\n  glue::glue('{name_label}&lt;br&gt;{size_label}&lt;br&gt;{hb_label}')\n}\n\n\ngeo_data_labeled &lt;- geo_data |&gt; \n  mutate(nice_label = pmap(\n           list(\n             gp_practice_name, practice_list_size, hb2019name\n           ),\n           make_nice_label\n         ))\n\nm |&gt;\n  addMarkers(\n    data = geo_data_labeled,\n    lng = ~ longitude,\n    lat = ~ latitude,\n    clusterOptions = markerClusterOptions(), \n    clusterId = \"GP Practices\",\n    popup = ~nice_label\n    )\n\n\n\n\n\n\n\nConditional markers\nWe can also include conditional formatting for markers. These can work on continuous variables such as practice_list_size:\n\ngeo_data_big &lt;- geo_data |&gt; \n  filter(practice_list_size &gt;= 10000) # Filter for only large practices\n\npal_list_size &lt;- colorNumeric(palette = \"viridis\", domain = c(0, max(geo_data_big$practice_list_size)))\n\nm |&gt;\n  addCircleMarkers(\n    data = geo_data_big,\n    lng = ~ longitude,\n    lat = ~ latitude,\n    stroke = FALSE,\n    fillOpacity = 0.8,\n    radius = 6,\n    color = ~ pal_list_size(practice_list_size)\n  ) |&gt;\n  addLegend(\n    data = geo_data_big,\n    position = \"bottomright\",\n    pal = pal_list_size,\n    values = ~ practice_list_size,\n    title = \"Practice list size\",\n    opacity = 1\n  )\n\n\n\n\n\nWe can also use categorical variables to create conditional markers. To demonstrate this, we can create a new column called size_group which divides practices into discrete groups based on practice_list_size :\n\nsize_breaks &lt;- c(0, 5000, 10000, 15000, Inf)\nsize_labels &lt;- c(\"&lt;5000\", \"5000-10,000\", \"10,000-15,000\", \"&gt;15,000\")\n\ngeo_data_grouped &lt;- geo_data |&gt; \n  filter(!is.na(practice_list_size),\n         practice_list_size &gt; 0) |&gt; # Only keep practices with list size \n  mutate(size_group = cut(practice_list_size, breaks = size_breaks, labels = size_labels)) |&gt; # Create new discrete groups for practice size\nslice_sample(n = 100) # Keep only 100 practices for plotting\n\npal_size_group &lt;- colorFactor(palette = c(\"green\", \"yellow\", \"orange\", \"red\"), levels = levels(geo_data_grouped$size_group))\n\nm |&gt;\n  addCircleMarkers(\n    data = geo_data_grouped,\n    lng = ~ longitude,\n    lat = ~ latitude,\n    stroke = FALSE,\n    fillOpacity = 0.6,\n    radius = 6,\n    color = ~ pal_size_group(size_group)\n  ) |&gt; \n  addLegend(\n    data = geo_data_grouped,\n    position = \"bottomright\",\n    pal = pal_size_group,\n    values = ~ size_group,\n    title = \"Practice list size\",\n    opacity = 1\n  )"
  },
  {
    "objectID": "tutorial.html#recap",
    "href": "tutorial.html#recap",
    "title": "How to make maps with {leaflet} in R",
    "section": "Recap",
    "text": "Recap\n\nLeaflet is an open and free to use package (as long as you credit the contributors) that can be used to make maps in R\naddMarkers can be used to tag locations of interest\naddPopups can be used to add text to marked locations\ncolourFactor and colourNumeric can be used to add conditional formatting to markers\n\nThanks for following along and go give it a go yourself!"
  }
]